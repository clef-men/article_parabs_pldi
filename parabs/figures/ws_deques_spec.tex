\begin{figure}
\begin{mathparpagebreakable}
    \iPersistent{(\inv\ t\ \v{sz})}
  \\
    \infer[inv-agree]{
        \inv\ t\ \v{sz}_1
      \\\\
        \inv\ t\ \v{sz}_2
    }{
      \v{sz}_1 = \v{sz}_2
    }
  \and
    \infer[owner-exclusive]{
        \owner\ t\ i\ \v{status}_1\ \zooValsTwo_1
      \\\\
        \owner\ t\ i\ \v{status}_2\ \zooValsTwo_2
    }{
      \iFalse
    }
  \and
    \infer[inv-model]{
        \inv\ t\ \v{sz}
      \\\\
        \model\ t\ \zooValss
    }{
      \l{length}\ \zooValss = \v{sz}
    }
  \and
    \infer[inv-owner]{
        \inv\ t\ \v{sz}
      \\\\
        \owner\ t\ i\ \v{status}\ \zooValsTwo
    }{
      i < \v{sz}
    }
  \and
    \infer[model-owner]{
        \model\ t\ \zooValss
      \\\\
        \owner\ t\ i\ \v{status}\ \zooValsTwo
    }{
      \Exists \zooVals.
      \mapLookup{\zooValss}{i} = \Some{\zooVals} \iSep
      \l{suffix}\ \zooVals\ \zooValsTwo
    }
  \\
    \iSpec[
      lab=create-spec
    ]{
      0 \leq \v{sz}
    }{
      \c{create}\ \v{sz}
    }[
      t
    ]{
      \inv\ t\ \v{sz} \iSep \\
      \model\ t\ (\l{replicate}\ \v{sz}\ \nil) \iSep \\
      \iBigSep_{i \in \interval{\v{sz}}}
        \owner\ t\ i\ \constr{Nonblocked}\ \nil
    }
  \and
    \iSpec[
      lab=size-spec
    ]{
      \inv\ t\ \v{sz}
    }{
      \c{size}\ t
    }[
      \v{res}
    ]{
      \v{res} = \v{sz}
    }
  \and
    \iSpec[
      lab=block-spec
    ]{
      \inv\ t\ \v{sz} \iSep \\
      \owner\ t\ i\ \constr{Nonblocked}\ \zooValsTwo
    }{
      \c{block}\ t\ i
    }[
      \c{()}
    ]{
      \owner\ t\ i\ \constr{Blocked}\ \zooValsTwo
    }
  \and
    \iSpec[
      lab=unblock-spec
    ]{
      \inv\ t\ \v{sz} \iSep \\
      \owner\ t\ i\ \constr{Blocked}\ \zooValsTwo
    }{
      \c{unblock}\ t\ i
    }[
      \c{()}
    ]{
      \owner\ t\ i\ \constr{Nonblocked}\ \zooValsTwo
    }
  \and
    \iAspec[
      lab=push-spec
    ]{
      \inv\ t\ \v{sz} \iSep \\
      \owner\ t\ i\ \constr{Nonblocked}\ \zooValsTwo
    }[
      \zooValss
    ]{
      \model\ t\ \zooValss
    }{
      \c{push}\ t\ i\ \zooVal
    }[
      \zooVals
    ]{
      \mapLookup{\zooValss}{i} = \Some{\zooVals} \iSep \\
      \l{suffix}\ \zooVals\ \zooValsTwo \iSep \\
      \model\ t\ (\mapInsert{i}{\zooVals \dplus [\zooVal]}{\zooValss})
    }[
      \c{()}
    ]{
      \owner\ t\ i\ \constr{Nonblocked}\ (\zooVals \dplus [\zooVal])
    }
  \and
    \iAspec[
      lab=pop-spec
    ]{
      \inv\ t\ \v{sz} \iSep \\
      \owner\ t\ i\ \constr{Nonblocked}\ \zooValsTwo
    }[
      \zooValss
    ]{
      \model\ t\ \zooValss
    }{
      \c{pop}\ t\ i
    }[
      o\ \zooValsTwo'
    ]{
      \matchOption{
        o
      }{
        \mapLookup{\zooValss}{i} = \Some{\nil} \iSep \\
        \zooValsTwo' = \nil \iSep \\
        \model\ t\ \zooValss
      }{
        \zooVal
      }{
        \Exists \zooVals. \\
        \mapLookup{\zooValss}{i} = \Some{(\zooVals \dplus [\zooVal])} \iSep \\
        \l{suffix}\ (\zooVals \dplus [\zooVal])\ \zooValsTwo \iSep \\
        \zooValsTwo' = \zooVals \iSep \\
        \model\ t\ (\mapInsert{i}{\zooVals}{\zooValss})
      }
    }[
      \v{res}
    ]{
      \v{res} = o \iSep \\
      \owner\ t\ i\ \constr{Nonblocked}\ \zooValsTwo'
    }
\end{mathparpagebreakable}
\caption{\ocamlinline{Ws_deques}: Specification (1/2)}
\label{fig:parabs_ws_deques_spec}
\end{figure}

\begin{figure}
\ContinuedFloat
\begin{mathpar}
    \iAspec[
      lab=steal-to-spec
    ]{
      0 \leq j < \v{sz} \iSep \\
      \inv\ t\ \v{sz} \iSep \\
      \owner\ t\ i\ \constr{Blocked}\ \zooValsTwo
    }[
      \zooValss
    ]{
      \model\ t\ \zooValss
    }{
      \c{steal\_to}\ t\ i\ j
    }[
      o
    ]{
      \matchOption{
        o
      }{
        \model\ t\ \zooValss
      }{
        \zooVal
      }{
        \Exists \zooVals. \\
        \mapLookup{\zooValss}{j} = \Some{\cons{\zooVal}{\zooVals}} \iSep \\
        \model\ t\ (\mapInsert{j}{\zooVals}{\zooValss})
      }
    }[
      \v{res}
    ]{
      \v{res} = o \iSep \\
      \owner\ t\ i\ \constr{Blocked}\ \zooValsTwo
    }
  \and
    \iAspec[
      lab=steal-as-spec
    ]{
      0 < \v{sz} \iSep \\
      \inv\ t\ \v{sz} \iSep \\
      \owner\ t\ i\ \constr{Blocked}\ \zooValsTwo \iSep \\
      \l{random-round.model}\ \v{round}\ (\v{sz} - 1)\ (\v{sz} - 1)
    }[
      \zooValss
    ]{
      \model\ t\ \zooValss
    }{
      \c{steal\_as}\ t\ i\ \v{round}
    }[
      o
    ]{
      \matchOption{
        o
      }{
        \model\ t\ \zooValss
      }{
        \zooVal
      }{
        \Exists j\ \zooVals. \\
        i \neq j \iSep \\
        \mapLookup{\zooValss}{j} = \Some{\cons{\zooVal}{\zooVals}} \iSep \\
        \model\ t\ (\mapInsert{j}{\zooVals}{\zooValss})
      }
    }[
      \v{res}
    ]{
      \Exists \zooInt. \\
      \v{res} = o \iSep \\
      \owner\ t\ i\ \constr{Blocked}\ \zooValsTwo \iSep \\
      \l{random-round.model}\ \v{round}\ (\v{sz} - 1)\ \zooInt
    }
\end{mathpar}
\caption{\ocamlinline{Ws_deques}: Specification (2/2)}
\label{fig:parabs_ws_deques_spec}
\end{figure}
